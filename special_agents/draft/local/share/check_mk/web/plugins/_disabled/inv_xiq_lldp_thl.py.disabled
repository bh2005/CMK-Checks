#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# XIQ LLDP/CDP Inventory – THL-style (CMK 2.4)
# Sorting via table header; columns from global settings (config)
# Pfad ~/local/share/check_mk/web/plugins/views/

from cmk.gui.i18n import _

try:
    # Ältere CMK-Versionen
    from cmk.gui.config import config  # noqa: F401
except Exception:
    # CMK 2.2/2.3/2.4+
    from cmk.gui.config import active_config as config  # type: ignore


try:
    from cmk.gui.views.inventory.registry import inventory_displayhints
except Exception:
    from cmk.gui.inventory import displayhints as inventory_displayhints  # fallback

from cmk.gui.plugins.views.inventory import render_inv_dicttable

INV_PATH = ".networking.lldp_infos:"

DEFAULT_COLS = [
    "hostaddress", "hostname", "id", "local_port",
    "mac_address", "management_ip", "port_description",
    "remote_device", "remote_port", "neighbor_key",
]

# Read global settings (Setup → Global settings → XIQ Inventory)
params = getattr(config, "xiq_inventory_display_lldp", None)
if isinstance(params, dict) and params:
    KEYORDER = [c for c in DEFAULT_COLS if params.get(c, False)] or DEFAULT_COLS
else:
    KEYORDER = DEFAULT_COLS

inventory_displayhints.update({
    INV_PATH: {
        "title": _("LLDP/CDP Neighbors"),
        "icon": "network",
        "render": render_inv_dicttable,
        "view": "inv_xiq_lldp",
        "keyorder": KEYORDER,
    },
    f"{INV_PATH}*.hostaddress":      {"title": _("Hostaddress"), "short": _("IP")},
    f"{INV_PATH}*.hostname":         {"title": _("Hostname"), "short": _("Host")},
    f"{INV_PATH}*.id":               {"title": _("ID"), "short": _("ID")},
    f"{INV_PATH}*.local_port":       {"title": _("Local Port"), "short": _("Local")},
    f"{INV_PATH}*.mac_address":      {"title": _("MAC Address"), "short": _("MAC")},
    f"{INV_PATH}*.management_ip":    {"title": _("Mgmt IP"), "short": _("Mgmt")},
    f"{INV_PATH}*.port_description": {"title": _("Port Description"), "short": _("Descr")},
    f"{INV_PATH}*.remote_device":    {"title": _("Remote Device"), "short": _("Remote")},
    f"{INV_PATH}*.remote_port":      {"title": _("Remote Port"), "short": _("R-Port")},
    f"{INV_PATH}*.neighbor_key":     {"title": _("Neighbor Key"), "short": _("N-Key")},
})
