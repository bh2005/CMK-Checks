#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
WATO GUI Integration for SMSEagle Notification Plugin

Provides configuration interface in Check_MK GUI for SMSEagle notifications.

Install to: local/share/check_mk/web/plugins/wato/smseagle_notifications.py
"""

from cmk.gui.i18n import _
from cmk.gui.valuespec import (
    Alternative,
    CascadingDropdown,
    Dictionary,
    DropdownChoice,
    FixedValue,
    Integer,
    ListOfStrings,
    Password,
    TextInput,
    TextAreaUnicode,
    Tuple,
)
from cmk.gui.plugins.wato.utils import (
    notification_parameter_registry,
    NotificationParameter,
)


@notification_parameter_registry.register
class NotificationParameterSMSEagle(NotificationParameter):
    @property
    def ident(self) -> str:
        return "smseagle"

    @property
    def spec(self):
        return Dictionary(
            title=_("Create notification via SMSEagle"),
            help=_(
                "Send notifications via SMSEagle device using SMS, TTS calls, or Wave files. "
                "Supports automatic failover to a secondary SMSEagle device."
            ),
            optional_keys=[
                "secondary_url",
                "secondary_token",
                "message_template",
                "verify_ssl",
            ],
            elements=[
                # Primary Server Configuration
                (
                    "primary_url",
                    TextInput(
                        title=_("Primary SMSEagle URL"),
                        help=_(
                            "Base URL of your primary SMSEagle device. "
                            "Example: http://192.168.1.100 or https://smseagle.company.com"
                        ),
                        size=50,
                        allow_empty=False,
                        regex="^https?://.*",
                        regex_error=_("URL must start with http:// or https://"),
                    ),
                ),
                (
                    "primary_token",
                    Password(
                        title=_("Primary Access Token"),
                        help=_(
                            "API access token for the primary SMSEagle device. "
                            "Generate this in SMSEagle web interface: Settings → API → Access Tokens"
                        ),
                        allow_empty=False,
                    ),
                ),
                
                # Secondary Server (Failover)
                (
                    "secondary_url",
                    TextInput(
                        title=_("Secondary SMSEagle URL (optional)"),
                        help=_(
                            "Base URL of your secondary/backup SMSEagle device. "
                            "Will be used if primary device fails."
                        ),
                        size=50,
                        regex="^https?://.*",
                        regex_error=_("URL must start with http:// or https://"),
                    ),
                ),
                (
                    "secondary_token",
                    Password(
                        title=_("Secondary Access Token (optional)"),
                        help=_("API access token for the secondary SMSEagle device"),
                    ),
                ),
                
                # Message Type and Configuration
                (
                    "message_type",
                    CascadingDropdown(
                        title=_("Message Type"),
                        help=_("Choose how to send the notification"),
                        choices=[
                            (
                                "sms",
                                _("SMS Text Message"),
                                FixedValue(
                                    None,
                                    help=_("Send notification as SMS text message"),
                                    totext=_("Standard SMS"),
                                ),
                            ),
                            (
                                "call_tts",
                                _("Voice Call (Text-to-Speech)"),
                                FixedValue(
                                    None,
                                    help=_("Call recipient and read message using text-to-speech"),
                                    totext=_("TTS Voice Call"),
                                ),
                            ),
                            (
                                "wave",
                                _("Voice Call (WAV File)"),
                                Integer(
                                    title=_("Wave File ID"),
                                    help=_(
                                        "ID of the WAV file stored in SMSEagle. "
                                        "Upload WAV files in SMSEagle: Settings → Soundboard"
                                    ),
                                    minvalue=1,
                                ),
                            ),
                        ],
                        default_value="sms",
                    ),
                ),
                
                # Modem Configuration
                (
                    "modem_no",
                    Integer(
                        title=_("Modem Number"),
                        help=_(
                            "Which modem to use for sending (1-4). "
                            "Check your SMSEagle device for available modems."
                        ),
                        default_value=1,
                        minvalue=1,
                        maxvalue=4,
                    ),
                ),
                
                # SSL Verification
                (
                    "verify_ssl",
                    DropdownChoice(
                        title=_("SSL Certificate Verification"),
                        help=_(
                            "Enable or disable SSL certificate verification. "
                            "Disable only if using self-signed certificates (not recommended for production)"
                        ),
                        choices=[
                            (True, _("Enable (recommended)")),
                            (False, _("Disable (insecure)")),
                        ],
                        default_value=True,
                    ),
                ),
                
                # Custom Message Template
                (
                    "message_template",
                    TextAreaUnicode(
                        title=_("Custom Message Template"),
                        help=_(
                            "Customize the notification message using Check_MK variables. "
                            "Leave empty to use default format. Available variables:<br>"
                            "<ul>"
                            "<li><tt>$HOSTNAME$</tt> - Host name</li>"
                            "<li><tt>$HOSTALIAS$</tt> - Host alias</li>"
                            "<li><tt>$HOSTADDRESS$</tt> - Host IP address</li>"
                            "<li><tt>$HOSTSTATE$</tt> - Host state (UP, DOWN, etc.)</li>"
                            "<li><tt>$HOSTSHORTSTATE$</tt> - Short host state (U, D, etc.)</li>"
                            "<li><tt>$HOSTOUTPUT$</tt> - Host check output</li>"
                            "<li><tt>$SERVICEDESC$</tt> - Service description</li>"
                            "<li><tt>$SERVICESTATE$</tt> - Service state (OK, WARNING, etc.)</li>"
                            "<li><tt>$SERVICESHORTSTATE$</tt> - Short service state (O, W, C, U)</li>"
                            "<li><tt>$SERVICEOUTPUT$</tt> - Service check output</li>"
                            "<li><tt>$NOTIFICATIONTYPE$</tt> - Type (PROBLEM, RECOVERY, etc.)</li>"
                            "</ul>"
                        ),
                        rows=4,
                        cols=60,
                        monospaced=True,
                    ),
                ),
            ],
        )


# =============================================================================
# User Attribute for Pager Field (Recipient Configuration)
# =============================================================================

# This provides a nice interface for configuring recipients per user
# Install to same file or separate file in: local/share/check_mk/web/plugins/wato/

from cmk.gui.plugins.userdb.utils import (
    user_attribute_registry,
    UserAttribute,
)

@user_attribute_registry.register
class SMSEaglePagerAttribute(UserAttribute):
    @property
    def name(self):
        return "pager"
    
    @property  
    def valuespec(self):
        return TextInput(
            title=_("Pager / SMS Number"),
            help=_(
                "Configure how to reach this user via SMSEagle. Supported formats:<br>"
                "<ul>"
                "<li><b>Phone number:</b> <tt>+491234567890</tt></li>"
                "<li><b>SMSEagle contacts:</b> <tt>contacts:12,15</tt></li>"
                "<li><b>SMSEagle groups:</b> <tt>groups:1,2</tt></li>"
                "<li><b>Combination:</b> <tt>+491234567890;groups:1</tt> (semicolon separated)</li>"
                "</ul>"
                "Examples:<br>"
                "<tt>+491234567890</tt> - Send to phone number<br>"
                "<tt>contacts:12,15</tt> - Send to SMSEagle contact IDs 12 and 15<br>"
                "<tt>groups:1</tt> - Send to all members of SMSEagle group 1<br>"
                "<tt>+491234567890;groups:1</tt> - Send to phone AND group"
            ),
            size=50,
        )


# =============================================================================
# Example Notification Rule Configuration
# =============================================================================

"""
After installing, create a notification rule in WATO:

Setup → Notifications → Add rule

Configuration:
1. Notification Method: SMSEagle
2. Primary SMSEagle URL: http://192.168.1.100
3. Primary Access Token: your-token-here
4. Message Type: SMS Text Message
5. Modem Number: 1

6. Conditions:
   - Contact selection: All contacts
   - Or: Specific contacts with pager field set
   
7. Custom Message Template (example):
   Alert: $HOSTNAME$ $SERVICEDESC$ is $SERVICESTATE$
   Output: $SERVICEOUTPUT$

Users Configuration:
Setup → Users → Edit user → Pager field:
   +491234567890
   or
   contacts:12;groups:1
"""
